<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10-Q SEC EDGAR Analyzer</title>
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #131920;
            --bg-tertiary: #1a2028;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --accent-blue: #2f81f7;
            --accent-green: #238636;
            --accent-red: #da3633;
            --accent-yellow: #d29922;
            --accent-purple: #8957e5;
            --accent-cyan: #39c5cf;
            --border-color: #30363d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2rem;
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
        }

        .url-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .url-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .url-card h3 {
            color: var(--accent-blue);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .url-card input {
            width: 100%;
            padding: 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .url-card input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .url-card input::placeholder {
            color: var(--text-secondary);
        }

        .status {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            min-height: 1.2rem;
        }

        .status.loading { color: var(--accent-yellow); }
        .status.success { color: var(--accent-green); }
        .status.error { color: var(--accent-red); }

        .example-urls {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 3px solid var(--accent-yellow);
        }

        .example-urls h4 {
            color: var(--accent-yellow);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .example-urls code {
            display: block;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 0.25rem 0;
            word-break: break-all;
            color: var(--text-secondary);
        }

        .example-urls button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--accent-blue);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .example-urls button:hover {
            background: var(--accent-blue);
            color: white;
        }

        .analyze-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 1rem auto;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .analyze-btn:hover:not(:disabled) {
            background: #1f6feb;
            transform: translateY(-1px);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            display: none;
        }

        .results.visible {
            display: block;
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--accent-cyan);
            margin: 1.5rem 0 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.85rem;
        }

        th, td {
            padding: 0.6rem 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
            font-weight: 600;
            font-size: 0.8rem;
        }

        tr:hover {
            background: rgba(47, 129, 247, 0.05);
        }

        .metric-name {
            color: var(--text-secondary);
        }

        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }
        .na { color: var(--text-secondary); font-style: italic; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .summary-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            border-left: 3px solid var(--accent-green);
        }

        .summary-card.warning {
            border-left-color: var(--accent-red);
        }

        .summary-card h4 {
            color: var(--accent-green);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .summary-card.warning h4 {
            color: var(--accent-red);
        }

        .summary-card p {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .red-flag {
            color: var(--accent-red);
            padding: 0.25rem 0;
            font-size: 0.85rem;
        }

        .export-btns {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .export-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .loading-indicator {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            display: none;
        }

        .loading-indicator.visible {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .cors-notice {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-yellow);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .cors-notice h4 {
            color: var(--accent-yellow);
            margin-bottom: 0.5rem;
        }

        .cors-notice p {
            color: var(--text-secondary);
        }

        .cors-notice a {
            color: var(--accent-blue);
        }

        .debug-info {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.75rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .debug-info.visible {
            display: block;
        }

        @media (max-width: 900px) {
            .url-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä 10-Q SEC EDGAR Analyzer</h1>
            <p class="subtitle">Analyze and compare SEC 10-Q HTML filings directly from EDGAR</p>
        </header>

        <div class="cors-notice">
            <h4>‚ö†Ô∏è Browser Security Note</h4>
            <p>Due to browser security (CORS), you may need to use a CORS proxy or download the HTML files. 
            The tool will first try to fetch directly, then fall back to a proxy. 
            Alternatively, <strong>right-click ‚Üí Save As</strong> the SEC HTML page and use the <a href="10q_analyzer.html">file upload version</a>.</p>
        </div>

        <div class="example-urls">
            <h4>üìã Example SEC EDGAR URLs (click to use)</h4>
            <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                <code id="ex1">https://www.sec.gov/Archives/edgar/data/1652044/000165204424000091/goog-20240930.htm</code>
                <button onclick="useExample(1, 'ex1')">Use</button>
            </div>
            <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                <code id="ex2">https://www.sec.gov/Archives/edgar/data/1045810/000104581024000316/nvda-20241027.htm</code>
                <button onclick="useExample(2, 'ex2')">Use</button>
            </div>
            <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                <code id="ex3">https://www.sec.gov/Archives/edgar/data/320193/000032019324000123/aapl-20240928.htm</code>
                <button onclick="useExample(3, 'ex3')">Use</button>
            </div>
        </div>

        <div class="url-section">
            <div class="url-card">
                <h3>Company 1</h3>
                <input type="text" id="url1" placeholder="Paste SEC EDGAR HTML URL...">
                <div class="status" id="status1"></div>
            </div>
            <div class="url-card">
                <h3>Company 2</h3>
                <input type="text" id="url2" placeholder="Paste SEC EDGAR HTML URL...">
                <div class="status" id="status2"></div>
            </div>
            <div class="url-card">
                <h3>Company 3</h3>
                <input type="text" id="url3" placeholder="Paste SEC EDGAR HTML URL...">
                <div class="status" id="status3"></div>
            </div>
        </div>

        <button class="analyze-btn" onclick="analyzeAll()" id="analyzeBtn">
            üîç Fetch & Analyze
        </button>

        <div class="loading-indicator" id="loading">
            <span class="spinner"></span>
            Fetching and analyzing SEC filings...
        </div>

        <div class="results" id="results">
            <div class="export-btns">
                <button class="export-btn" onclick="exportMarkdown()">üìù Markdown</button>
                <button class="export-btn" onclick="exportJSON()">üìä JSON</button>
                <button class="export-btn" onclick="exportCSV()">üìà CSV</button>
            </div>

            <h2 class="section-title">üìã Company Overview</h2>
            <table id="overviewTable">
                <thead><tr><th>#</th><th>Company</th><th>Filing Period</th><th>CIK</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üí∞ Income Statement (in millions USD)</h2>
            <table id="incomeTable">
                <thead><tr><th>Metric</th><th id="i-h1">Co 1</th><th id="i-h2">Co 2</th><th id="i-h3">Co 3</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üè¶ Balance Sheet (in millions USD)</h2>
            <table id="balanceTable">
                <thead><tr><th>Metric</th><th id="b-h1">Co 1</th><th id="b-h2">Co 2</th><th id="b-h3">Co 3</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üíµ Cash Flow (in millions USD)</h2>
            <table id="cashflowTable">
                <thead><tr><th>Metric</th><th id="c-h1">Co 1</th><th id="c-h2">Co 2</th><th id="c-h3">Co 3</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üìä Key Ratios</h2>
            <table id="ratiosTable">
                <thead><tr><th>Metric</th><th id="r-h1">Co 1</th><th id="r-h2">Co 2</th><th id="r-h3">Co 3</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üèÜ Executive Summary</h2>
            <div class="summary-grid" id="summaryCards"></div>

            <h2 class="section-title">‚ö†Ô∏è Red Flags</h2>
            <div class="summary-grid" id="redFlags"></div>
        </div>
    </div>

    <script>
        let analysisResults = [];

        function useExample(num, exId) {
            document.getElementById(`url${num}`).value = document.getElementById(exId).textContent;
        }

        async function fetchHTML(url, statusEl) {
            statusEl.className = 'status loading';
            statusEl.textContent = 'Fetching...';

            const proxies = [
                '',
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
            ];

            for (const proxy of proxies) {
                try {
                    const fetchUrl = proxy ? proxy + encodeURIComponent(url) : url;
                    const response = await fetch(fetchUrl, {
                        headers: proxy ? {} : { 'Accept': 'text/html' }
                    });
                    
                    if (response.ok) {
                        const html = await response.text();
                        if (html.length > 1000 && (html.includes('10-Q') || html.includes('10-K') || html.includes('FORM') || html.includes('<table'))) {
                            statusEl.className = 'status success';
                            statusEl.textContent = '‚úì Loaded successfully';
                            return html;
                        }
                    }
                } catch (e) {
                    console.log(`Proxy ${proxy || 'direct'} failed:`, e.message);
                }
            }

            statusEl.className = 'status error';
            statusEl.textContent = '‚úó Failed - try downloading the file';
            return null;
        }

        function parseNumber(str) {
            if (!str || typeof str !== 'string') return null;
            str = str.trim();
            if (str === '' || str === '‚Äî' || str === '-' || str === 'N/A' || str === '‚Äì' || str === '‚Äî') return null;
            
            // Remove currency symbols, commas, spaces
            let clean = str.replace(/[$‚Ç¨¬£¬•,\s]/g, '');
            
            // Check for parentheses or leading minus (negative)
            const isNegative = clean.includes('(') || clean.startsWith('-') || clean.includes('‚àí');
            clean = clean.replace(/[()‚àí\-]/g, '');
            
            // Must be a valid number
            if (!/^\d+\.?\d*$/.test(clean)) return null;
            
            const num = parseFloat(clean);
            if (isNaN(num)) return null;
            
            return isNegative ? -num : num;
        }

        // Detect the multiplier from table headers/context (thousands, millions, billions)
        function detectMultiplier(tableText) {
            const text = tableText.toLowerCase();
            if (text.includes('in billions') || text.includes('(billions)')) return 1000; // Convert to millions
            if (text.includes('in thousands') || text.includes('(thousands)') || text.includes('$ in thousands')) return 0.001; // Convert to millions
            if (text.includes('in millions') || text.includes('(millions)') || text.includes('$ in millions')) return 1;
            // Default: assume millions for large companies
            return 1;
        }

        // Score how likely a table is to be a financial statement
        function scoreFinancialTable(table, statementType) {
            let score = 0;
            const text = table.textContent.toLowerCase();
            const rows = table.querySelectorAll('tr');
            
            // Must have reasonable structure
            if (rows.length < 3) return 0;
            if (rows.length > 100) score -= 5; // Too many rows = probably notes
            
            // Check for statement-specific keywords
            if (statementType === 'income') {
                if (text.includes('consolidated statements of income') || 
                    text.includes('consolidated statements of operations') ||
                    text.includes('condensed consolidated statements of income') ||
                    text.includes('condensed consolidated statements of operations')) score += 20;
                if (text.includes('revenue') && text.includes('net income')) score += 10;
                if (text.includes('three months ended') || text.includes('nine months ended')) score += 5;
            } else if (statementType === 'balance') {
                if (text.includes('consolidated balance sheet') ||
                    text.includes('condensed consolidated balance sheet')) score += 20;
                if (text.includes('total assets') && text.includes('total liabilities')) score += 10;
            } else if (statementType === 'cashflow') {
                if (text.includes('consolidated statements of cash flows') ||
                    text.includes('condensed consolidated statements of cash flows')) score += 20;
                if (text.includes('operating activities') && text.includes('investing activities')) score += 10;
            }
            
            // Penalize if it looks like notes/schedules
            if (text.includes('note ') || text.includes('schedule ')) score -= 10;
            if (text.includes('fair value') && statementType !== 'balance') score -= 5;
            
            // Check for dollar amounts (good sign)
            const dollarMatches = text.match(/\$[\d,]+/g);
            if (dollarMatches && dollarMatches.length > 5) score += 5;
            
            return score;
        }

        // Find the best table for a given statement type
        function findBestTable(doc, statementType) {
            const tables = doc.querySelectorAll('table');
            let bestTable = null;
            let bestScore = -Infinity;
            
            for (const table of tables) {
                const score = scoreFinancialTable(table, statementType);
                if (score > bestScore) {
                    bestScore = score;
                    bestTable = table;
                }
            }
            
            return bestScore > 0 ? bestTable : null;
        }

        // Extract a value from a specific table
        function extractValueFromTable(table, keywords, multiplier = 1) {
            if (!table) return null;
            
            const rows = table.querySelectorAll('tr');
            const keywordsLower = keywords.map(k => k.toLowerCase().trim());
            
            for (const row of rows) {
                const cells = Array.from(row.querySelectorAll('td, th'));
                if (cells.length < 2) continue;
                
                // Get the label (first cell with text)
                let labelCell = cells.find(c => c.textContent.trim().length > 2);
                if (!labelCell) continue;
                
                const labelText = labelCell.textContent.toLowerCase().trim();
                
                // Check if this row matches our keywords
                let matches = false;
                for (const keyword of keywordsLower) {
                    // More precise matching - the label should START with or closely match the keyword
                    if (labelText.includes(keyword)) {
                        // Avoid partial matches like "total assets" matching "total assets under management"
                        const keywordIndex = labelText.indexOf(keyword);
                        // Keyword should be near the start or be a significant part
                        if (keywordIndex < 20 || labelText.length < keyword.length + 30) {
                            matches = true;
                            break;
                        }
                    }
                }
                
                if (!matches) continue;
                
                // Look for numeric values in subsequent cells (prefer the most recent quarter)
                // Usually the first numeric column after the label is the most recent period
                for (let i = 1; i < cells.length; i++) {
                    const cellText = cells[i].textContent.trim();
                    const num = parseNumber(cellText);
                    if (num !== null && num !== 0) {
                        return num * multiplier;
                    }
                }
            }
            
            return null;
        }

        function extractCompanyInfo(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const text = doc.body.textContent.substring(0, 20000);
            
            // Company name - look for common patterns
            let name = 'Unknown';
            
            // Try to find company name from title or header
            const titleEl = doc.querySelector('title');
            if (titleEl) {
                const titleText = titleEl.textContent;
                // Often format: "Company Name - 10-Q"
                const titleMatch = titleText.match(/^([^-‚Äì]+)/);
                if (titleMatch && titleMatch[1].length > 3 && titleMatch[1].length < 50) {
                    name = titleMatch[1].trim();
                }
            }
            
            // Fallback patterns
            if (name === 'Unknown') {
                const patterns = [
                    /REGISTRANT[:\s]+([A-Z][A-Za-z\s&,\.]+(?:Inc\.|Corporation|Corp\.|LLC|Company|Co\.|LP|Ltd\.))/i,
                    /COMPANY NAME[:\s]+([A-Z][A-Za-z\s&,\.]+)/i,
                    /(?:^|\n)([A-Z][A-Z\s&]+(?:INC\.|CORPORATION|CORP\.|LLC|COMPANY|CO\.))/m,
                ];
                
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match && match[1].length > 3 && match[1].length < 60) {
                        name = match[1].trim().replace(/\s+/g, ' ');
                        // Title case
                        name = name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                        break;
                    }
                }
            }
            
            // Filing period
            let period = 'N/A';
            const periodPatterns = [
                /(?:QUARTERLY|QUARTER|PERIOD)\s+(?:ENDED?|ENDING)\s+(\w+\s+\d{1,2},?\s+\d{4})/i,
                /(?:THREE|NINE|SIX)\s+MONTHS\s+ENDED\s+(\w+\s+\d{1,2},?\s+\d{4})/i,
                /(?:FOR THE PERIOD ENDED|AS OF)\s+(\w+\s+\d{1,2},?\s+\d{4})/i,
            ];
            
            for (const pattern of periodPatterns) {
                const match = text.match(pattern);
                if (match) {
                    period = match[1].trim();
                    break;
                }
            }
            
            // CIK
            let cik = 'N/A';
            const cikMatch = text.match(/CIK[:\s#]+(\d{7,10})/i) || 
                            text.match(/edgar\/data\/(\d+)/i) ||
                            text.match(/Commission File Number[:\s]+(\d+-\d+)/i);
            if (cikMatch) {
                cik = cikMatch[1];
            }
            
            return { name, period, cik };
        }

        function analyzeHTML(html, url) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const info = extractCompanyInfo(html);
            
            // Find the best tables for each statement type
            const incomeTable = findBestTable(doc, 'income');
            const balanceTable = findBestTable(doc, 'balance');
            const cashflowTable = findBestTable(doc, 'cashflow');
            
            // Detect multipliers
            const incomeMultiplier = incomeTable ? detectMultiplier(incomeTable.textContent) : 1;
            const balanceMultiplier = balanceTable ? detectMultiplier(balanceTable.textContent) : 1;
            const cashflowMultiplier = cashflowTable ? detectMultiplier(cashflowTable.textContent) : 1;
            
            const financials = {
                // Income Statement
                revenue: extractValueFromTable(incomeTable, [
                    'total revenues', 'revenues', 'net revenues', 'total net revenues', 
                    'net sales', 'total sales', 'total net sales', 'revenue'
                ], incomeMultiplier),
                
                costOfRevenue: extractValueFromTable(incomeTable, [
                    'cost of revenues', 'cost of revenue', 'cost of sales', 
                    'cost of goods sold', 'cost of products sold'
                ], incomeMultiplier),
                
                grossProfit: extractValueFromTable(incomeTable, [
                    'gross profit', 'gross margin'
                ], incomeMultiplier),
                
                operatingIncome: extractValueFromTable(incomeTable, [
                    'income from operations', 'operating income', 'operating income (loss)'
                ], incomeMultiplier),
                
                netIncome: extractValueFromTable(incomeTable, [
                    'net income', 'net income (loss)', 'net earnings', 
                    'net income attributable to', 'net income attributable'
                ], incomeMultiplier),
                
                // Balance Sheet
                totalAssets: extractValueFromTable(balanceTable, [
                    'total assets'
                ], balanceMultiplier),
                
                cash: extractValueFromTable(balanceTable, [
                    'cash and cash equivalents', 'cash, cash equivalents',
                    'cash and equivalents'
                ], balanceMultiplier),
                
                marketableSecurities: extractValueFromTable(balanceTable, [
                    'marketable securities', 'short-term investments',
                    'short-term marketable securities'
                ], balanceMultiplier),
                
                currentAssets: extractValueFromTable(balanceTable, [
                    'total current assets'
                ], balanceMultiplier),
                
                totalLiabilities: extractValueFromTable(balanceTable, [
                    'total liabilities'
                ], balanceMultiplier),
                
                currentLiabilities: extractValueFromTable(balanceTable, [
                    'total current liabilities'
                ], balanceMultiplier),
                
                longTermDebt: extractValueFromTable(balanceTable, [
                    'long-term debt', 'long-term notes payable',
                    'long-term borrowings', 'notes payable'
                ], balanceMultiplier),
                
                totalEquity: extractValueFromTable(balanceTable, [
                    "total stockholders' equity", "total shareholders' equity", 
                    "stockholders' equity", "shareholders' equity",
                    'total equity'
                ], balanceMultiplier),
                
                // Cash Flow
                operatingCF: extractValueFromTable(cashflowTable, [
                    'net cash provided by operating activities',
                    'net cash from operating activities',
                    'cash provided by operating activities'
                ], cashflowMultiplier),
                
                investingCF: extractValueFromTable(cashflowTable, [
                    'net cash used in investing activities',
                    'net cash from investing activities',
                    'cash used in investing activities'
                ], cashflowMultiplier),
                
                financingCF: extractValueFromTable(cashflowTable, [
                    'net cash used in financing activities',
                    'net cash from financing activities',
                    'cash used in financing activities'
                ], cashflowMultiplier),
                
                capex: extractValueFromTable(cashflowTable, [
                    'purchases of property and equipment',
                    'capital expenditures',
                    'purchases of property, plant and equipment',
                    'acquisition of property and equipment'
                ], cashflowMultiplier),
            };
            
            // Calculated metrics
            if (financials.operatingCF !== null && financials.capex !== null) {
                financials.freeCashFlow = financials.operatingCF - Math.abs(financials.capex);
            }
            
            if (financials.revenue && financials.netIncome && financials.revenue !== 0) {
                financials.netMargin = (financials.netIncome / financials.revenue) * 100;
            }
            
            if (financials.currentAssets && financials.currentLiabilities && financials.currentLiabilities !== 0) {
                financials.currentRatio = financials.currentAssets / financials.currentLiabilities;
            }
            
            if (financials.longTermDebt && financials.totalAssets && financials.totalAssets !== 0) {
                financials.debtToAssets = (financials.longTermDebt / financials.totalAssets) * 100;
            }
            
            if (financials.cash !== null && financials.longTermDebt !== null) {
                financials.netCash = financials.cash - (financials.longTermDebt || 0);
            }
            
            return {
                name: info.name,
                period: info.period,
                cik: info.cik,
                url: url,
                financials: financials
            };
        }

        async function analyzeAll() {
            const urls = [
                document.getElementById('url1').value.trim(),
                document.getElementById('url2').value.trim(),
                document.getElementById('url3').value.trim()
            ];
            
            if (urls.some(u => !u)) {
                alert('Please enter all 3 URLs');
                return;
            }
            
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loading').classList.add('visible');
            document.getElementById('results').classList.remove('visible');
            
            analysisResults = [];
            
            for (let i = 0; i < 3; i++) {
                const statusEl = document.getElementById(`status${i + 1}`);
                const html = await fetchHTML(urls[i], statusEl);
                
                if (html) {
                    const result = analyzeHTML(html, urls[i]);
                    analysisResults.push(result);
                } else {
                    analysisResults.push({
                        name: `Company ${i + 1} (Failed)`,
                        period: 'N/A',
                        cik: 'N/A',
                        url: urls[i],
                        financials: {}
                    });
                }
            }
            
            document.getElementById('loading').classList.remove('visible');
            document.getElementById('analyzeBtn').disabled = false;
            
            displayResults();
        }

        function fmt(val, decimals = 0) {
            if (val === null || val === undefined) return '<span class="na">N/A</span>';
            
            const absVal = Math.abs(val);
            let formatted;
            let suffix = 'M';
            
            // Values are already in millions
            if (absVal >= 1000) {
                formatted = (val / 1000).toFixed(1);
                suffix = 'B';
            } else if (absVal >= 1) {
                formatted = val.toFixed(decimals);
                suffix = 'M';
            } else {
                formatted = (val * 1000).toFixed(0);
                suffix = 'K';
            }
            
            const cls = val < 0 ? 'negative' : 'positive';
            const sign = val < 0 ? '-' : '';
            return `<span class="${cls}">${sign}$${Math.abs(parseFloat(formatted)).toFixed(formatted.includes('.') ? 1 : 0)}${suffix}</span>`;
        }

        function fmtPct(val) {
            if (val === null || val === undefined) return '<span class="na">N/A</span>';
            const cls = val < 0 ? 'negative' : 'positive';
            return `<span class="${cls}">${val.toFixed(1)}%</span>`;
        }

        function fmtRatio(val) {
            if (val === null || val === undefined) return '<span class="na">N/A</span>';
            const cls = val < 1 ? 'negative' : 'positive';
            return `<span class="${cls}">${val.toFixed(2)}</span>`;
        }

        function displayResults() {
            const cos = analysisResults;
            
            // Update headers
            ['i', 'b', 'c', 'r'].forEach(prefix => {
                for (let i = 0; i < 3; i++) {
                    document.getElementById(`${prefix}-h${i + 1}`).textContent = cos[i].name.substring(0, 18);
                }
            });
            
            // Overview
            document.querySelector('#overviewTable tbody').innerHTML = cos.map((c, i) => `
                <tr><td>${i + 1}</td><td>${c.name}</td><td>${c.period}</td><td>${c.cik}</td></tr>
            `).join('');
            
            // Income Statement
            const incomeMetrics = [
                ['Revenue', 'revenue'],
                ['Cost of Revenue', 'costOfRevenue'],
                ['Gross Profit', 'grossProfit'],
                ['Operating Income', 'operatingIncome'],
                ['Net Income', 'netIncome'],
                ['Net Margin', 'netMargin', 'pct'],
            ];
            
            document.querySelector('#incomeTable tbody').innerHTML = incomeMetrics.map(([label, key, type]) => `
                <tr>
                    <td class="metric-name">${label}</td>
                    ${cos.map(c => `<td>${type === 'pct' ? fmtPct(c.financials[key]) : fmt(c.financials[key])}</td>`).join('')}
                </tr>
            `).join('');
            
            // Balance Sheet
            const balanceMetrics = [
                ['Total Assets', 'totalAssets'],
                ['Cash & Equivalents', 'cash'],
                ['Marketable Securities', 'marketableSecurities'],
                ['Current Assets', 'currentAssets'],
                ['Total Liabilities', 'totalLiabilities'],
                ['Current Liabilities', 'currentLiabilities'],
                ['Long-Term Debt', 'longTermDebt'],
                ['Total Equity', 'totalEquity'],
            ];
            
            document.querySelector('#balanceTable tbody').innerHTML = balanceMetrics.map(([label, key]) => `
                <tr>
                    <td class="metric-name">${label}</td>
                    ${cos.map(c => `<td>${fmt(c.financials[key])}</td>`).join('')}
                </tr>
            `).join('');
            
            // Cash Flow
            const cfMetrics = [
                ['Operating Cash Flow', 'operatingCF'],
                ['Investing Cash Flow', 'investingCF'],
                ['Financing Cash Flow', 'financingCF'],
                ['Capital Expenditures', 'capex'],
                ['Free Cash Flow', 'freeCashFlow'],
            ];
            
            document.querySelector('#cashflowTable tbody').innerHTML = cfMetrics.map(([label, key]) => `
                <tr>
                    <td class="metric-name">${label}</td>
                    ${cos.map(c => `<td>${fmt(c.financials[key])}</td>`).join('')}
                </tr>
            `).join('');
            
            // Ratios
            const ratioMetrics = [
                ['Current Ratio', 'currentRatio', 'ratio'],
                ['Debt-to-Assets', 'debtToAssets', 'pct'],
                ['Net Cash Position', 'netCash', 'num'],
            ];
            
            document.querySelector('#ratiosTable tbody').innerHTML = ratioMetrics.map(([label, key, type]) => `
                <tr>
                    <td class="metric-name">${label}</td>
                    ${cos.map(c => `<td>${type === 'pct' ? fmtPct(c.financials[key]) : type === 'ratio' ? fmtRatio(c.financials[key]) : fmt(c.financials[key])}</td>`).join('')}
                </tr>
            `).join('');
            
            // Summary
            const summaries = [];
            const validAssets = cos.filter(c => c.financials.totalAssets);
            if (validAssets.length) {
                const best = validAssets.reduce((a, b) => (a.financials.totalAssets || 0) > (b.financials.totalAssets || 0) ? a : b);
                summaries.push({ title: 'üèÜ Largest by Assets', text: `${best.name}` });
            }
            
            const validRev = cos.filter(c => c.financials.revenue);
            if (validRev.length) {
                const best = validRev.reduce((a, b) => (a.financials.revenue || 0) > (b.financials.revenue || 0) ? a : b);
                summaries.push({ title: 'üí∞ Highest Revenue', text: `${best.name}` });
            }
            
            const validMargin = cos.filter(c => c.financials.netMargin !== null && c.financials.netMargin !== undefined);
            if (validMargin.length) {
                const best = validMargin.reduce((a, b) => (a.financials.netMargin || -999) > (b.financials.netMargin || -999) ? a : b);
                summaries.push({ title: 'üìà Best Net Margin', text: `${best.name} (${best.financials.netMargin.toFixed(1)}%)` });
            }
            
            document.getElementById('summaryCards').innerHTML = summaries.map(s => `
                <div class="summary-card"><h4>${s.title}</h4><p>${s.text}</p></div>
            `).join('') || '<div class="summary-card"><h4>üìä Analysis Complete</h4><p>Review the tables above for detailed metrics.</p></div>';
            
            // Red Flags
            const flags = [];
            for (const c of cos) {
                const f = [];
                if (c.financials.freeCashFlow !== null && c.financials.freeCashFlow < 0) {
                    f.push(`Negative FCF ($${(c.financials.freeCashFlow / 1000).toFixed(1)}B)`);
                }
                if (c.financials.debtToAssets !== null && c.financials.debtToAssets > 50) {
                    f.push(`High debt (${c.financials.debtToAssets.toFixed(0)}% of assets)`);
                }
                if (c.financials.currentRatio !== null && c.financials.currentRatio < 1) {
                    f.push(`Low current ratio (${c.financials.currentRatio.toFixed(2)})`);
                }
                if (c.financials.netIncome !== null && c.financials.netIncome < 0) {
                    f.push(`Net loss reported`);
                }
                if (f.length) flags.push({ company: c.name, flags: f });
            }
            
            document.getElementById('redFlags').innerHTML = flags.length ? flags.map(f => `
                <div class="summary-card warning">
                    <h4>‚ö†Ô∏è ${f.company.substring(0, 25)}</h4>
                    ${f.flags.map(fl => `<div class="red-flag">‚Ä¢ ${fl}</div>`).join('')}
                </div>
            `).join('') : '<div class="summary-card"><h4>‚úÖ No Major Red Flags</h4><p>All companies appear financially healthy based on available data.</p></div>';
            
            document.getElementById('results').classList.add('visible');
        }

        function exportMarkdown() {
            const cos = analysisResults;
            let md = `# 10-Q Comparison Report\n\n`;
            md += `Generated: ${new Date().toLocaleString()}\n\n`;
            md += `## Companies\n`;
            cos.forEach((c, i) => md += `${i + 1}. **${c.name}** - ${c.period}\n`);
            md += `\n## Key Metrics (in millions USD)\n`;
            md += `| Metric | ${cos.map(c => c.name.substring(0, 15)).join(' | ')} |\n`;
            md += `|--------|${cos.map(() => '---').join('|')}|\n`;
            
            const fmtMd = (v) => v === null ? 'N/A' : (Math.abs(v) >= 1000 ? `$${(v/1000).toFixed(1)}B` : `$${v.toFixed(0)}M`);
            
            md += `| Revenue | ${cos.map(c => fmtMd(c.financials.revenue)).join(' | ')} |\n`;
            md += `| Net Income | ${cos.map(c => fmtMd(c.financials.netIncome)).join(' | ')} |\n`;
            md += `| Total Assets | ${cos.map(c => fmtMd(c.financials.totalAssets)).join(' | ')} |\n`;
            md += `| Total Equity | ${cos.map(c => fmtMd(c.financials.totalEquity)).join(' | ')} |\n`;
            md += `| Operating CF | ${cos.map(c => fmtMd(c.financials.operatingCF)).join(' | ')} |\n`;
            
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '10q_comparison.md';
            a.click();
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify({ generated: new Date().toISOString(), companies: analysisResults }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '10q_comparison.json';
            a.click();
        }

        function exportCSV() {
            const cos = analysisResults;
            let csv = 'Metric,' + cos.map(c => `"${c.name}"`).join(',') + '\n';
            const metrics = ['revenue', 'netIncome', 'operatingIncome', 'grossProfit', 'totalAssets', 'cash', 'totalLiabilities', 'longTermDebt', 'totalEquity', 'operatingCF', 'freeCashFlow', 'netMargin', 'currentRatio'];
            metrics.forEach(m => {
                csv += `${m},${cos.map(c => c.financials[m] ?? '').join(',')}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '10q_comparison.csv';
            a.click();
        }
    </script>
</body>
</html>
