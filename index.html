<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10-Q SEC EDGAR Analyzer</title>
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #131920;
            --bg-tertiary: #1a2028;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --accent-blue: #2f81f7;
            --accent-green: #238636;
            --accent-red: #da3633;
            --accent-yellow: #d29922;
            --accent-purple: #8957e5;
            --accent-cyan: #39c5cf;
            --border-color: #30363d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        h1 { font-size: 2rem; color: var(--accent-cyan); margin-bottom: 0.5rem; }
        .subtitle { color: var(--text-secondary); }

        .url-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }

        .url-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .url-card h3 { color: var(--accent-blue); margin-bottom: 0.75rem; font-size: 0.9rem; }

        .url-card input {
            width: 100%;
            padding: 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .url-card input:focus { outline: none; border-color: var(--accent-blue); }
        .url-card input::placeholder { color: var(--text-secondary); }

        .status { margin-top: 0.5rem; font-size: 0.8rem; min-height: 1.2rem; }
        .status.loading { color: var(--accent-yellow); }
        .status.success { color: var(--accent-green); }
        .status.error { color: var(--accent-red); }

        .example-urls {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 3px solid var(--accent-yellow);
        }

        .example-urls h4 { color: var(--accent-yellow); margin-bottom: 0.5rem; font-size: 0.9rem; }

        .example-urls code {
            display: block;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 0.25rem 0;
            word-break: break-all;
            color: var(--text-secondary);
        }

        .example-urls button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--accent-blue);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .example-urls button:hover { background: var(--accent-blue); color: white; }

        .analyze-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 1rem auto;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .analyze-btn:hover:not(:disabled) { background: #1f6feb; transform: translateY(-1px); }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .results { display: none; }
        .results.visible { display: block; }

        .section-title {
            font-size: 1.1rem;
            color: var(--accent-cyan);
            margin: 1.5rem 0 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.85rem;
        }

        th, td { padding: 0.6rem 0.8rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-tertiary); color: var(--accent-blue); font-weight: 600; font-size: 0.8rem; }
        tr:hover { background: rgba(47, 129, 247, 0.05); }

        .metric-name { color: var(--text-secondary); }
        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }
        .na { color: var(--text-secondary); font-style: italic; }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin: 1rem 0; }

        .summary-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            border-left: 3px solid var(--accent-green);
        }

        .summary-card.warning { border-left-color: var(--accent-red); }
        .summary-card h4 { color: var(--accent-green); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .summary-card.warning h4 { color: var(--accent-red); }
        .summary-card p { color: var(--text-secondary); font-size: 0.85rem; }
        .red-flag { color: var(--accent-red); padding: 0.25rem 0; font-size: 0.85rem; }

        .export-btns { display: flex; gap: 0.5rem; justify-content: center; margin: 1rem 0; }

        .export-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .export-btn:hover { background: var(--accent-blue); border-color: var(--accent-blue); }

        .loading-indicator { text-align: center; padding: 2rem; color: var(--text-secondary); display: none; }
        .loading-indicator.visible { display: block; }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .cors-notice {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-yellow);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .cors-notice h4 { color: var(--accent-yellow); margin-bottom: 0.5rem; }
        .cors-notice p { color: var(--text-secondary); }
        .cors-notice a { color: var(--accent-blue); }

        @media (max-width: 900px) { .url-section { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä 10-Q SEC EDGAR Analyzer</h1>
            <p class="subtitle">Analyze and compare SEC 10-Q HTML filings directly from EDGAR</p>
        </header>

        <div class="cors-notice">
            <h4>‚ö†Ô∏è Browser Security Note</h4>
            <p>Due to browser security (CORS), you may need to use a CORS proxy or download the HTML files. 
            The tool will first try to fetch directly, then fall back to a proxy. 
            Alternatively, <strong>right-click ‚Üí Save As</strong> the SEC HTML page and use the <a href="10q_analyzer.html">file upload version</a>.</p>
        </div>

        <div class="example-urls">
            <h4>üìã Example SEC EDGAR URLs (click to use)</h4>
            <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                <code id="ex1">https://www.sec.gov/Archives/edgar/data/1783879/000178387925000310/hood-20250930.htm</code>
                <button onclick="useExample(1, 'ex1')">Use</button>
            </div>
            <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                <code id="ex2">https://www.sec.gov/Archives/edgar/data/1562088/000162828025049743/duol-20250930.htm</code>
                <button onclick="useExample(2, 'ex2')">Use</button>
            </div>
            <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                <code id="ex3">https://www.sec.gov/Archives/edgar/data/1810806/000181080625000169/unity-20250930.htm</code>
                <button onclick="useExample(3, 'ex3')">Use</button>
            </div>
        </div>

        <div class="url-section">
            <div class="url-card">
                <h3>Company 1</h3>
                <input type="text" id="url1" placeholder="Paste SEC EDGAR HTML URL...">
                <div class="status" id="status1"></div>
            </div>
            <div class="url-card">
                <h3>Company 2</h3>
                <input type="text" id="url2" placeholder="Paste SEC EDGAR HTML URL...">
                <div class="status" id="status2"></div>
            </div>
            <div class="url-card">
                <h3>Company 3</h3>
                <input type="text" id="url3" placeholder="Paste SEC EDGAR HTML URL...">
                <div class="status" id="status3"></div>
            </div>
        </div>

        <button class="analyze-btn" onclick="analyzeAll()" id="analyzeBtn">
            üîç Fetch & Analyze
        </button>

        <div class="loading-indicator" id="loading">
            <span class="spinner"></span>
            Fetching and analyzing SEC filings...
        </div>

        <div class="results" id="results">
            <div class="export-btns">
                <button class="export-btn" onclick="exportMarkdown()">üìù Markdown</button>
                <button class="export-btn" onclick="exportJSON()">üìä JSON</button>
                <button class="export-btn" onclick="exportCSV()">üìà CSV</button>
            </div>

            <h2 class="section-title">üìã Company Overview</h2>
            <table id="overviewTable">
                <thead><tr><th>#</th><th>Company</th><th>Filing Period</th><th>CIK</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üí∞ Income Statement (in millions USD)</h2>
            <table id="incomeTable">
                <thead><tr><th>Metric</th><th id="i-h1">Co 1</th><th id="i-h2">Co 2</th><th id="i-h3">Co 3</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üè¶ Balance Sheet (in millions USD)</h2>
            <table id="balanceTable">
                <thead><tr><th>Metric</th><th id="b-h1">Co 1</th><th id="b-h2">Co 2</th><th id="b-h3">Co 3</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üíµ Cash Flow (in millions USD)</h2>
            <table id="cashflowTable">
                <thead><tr><th>Metric</th><th id="c-h1">Co 1</th><th id="c-h2">Co 2</th><th id="c-h3">Co 3</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üìä Key Ratios</h2>
            <table id="ratiosTable">
                <thead><tr><th>Metric</th><th id="r-h1">Co 1</th><th id="r-h2">Co 2</th><th id="r-h3">Co 3</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2 class="section-title">üèÜ Executive Summary</h2>
            <div class="summary-grid" id="summaryCards"></div>

            <h2 class="section-title">‚ö†Ô∏è Red Flags</h2>
            <div class="summary-grid" id="redFlags"></div>
        </div>
    </div>

    <script>
        let analysisResults = [];

        function useExample(num, exId) {
            document.getElementById(`url${num}`).value = document.getElementById(exId).textContent;
        }

        async function fetchHTML(url, statusEl) {
            statusEl.className = 'status loading';
            statusEl.textContent = 'Fetching...';

            const proxies = [
                '',
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
            ];

            for (const proxy of proxies) {
                try {
                    const fetchUrl = proxy ? proxy + encodeURIComponent(url) : url;
                    const response = await fetch(fetchUrl, {
                        headers: proxy ? {} : { 'Accept': 'text/html' }
                    });
                    
                    if (response.ok) {
                        const html = await response.text();
                        if (html.length > 1000) {
                            statusEl.className = 'status success';
                            statusEl.textContent = '‚úì Loaded successfully';
                            return html;
                        }
                    }
                } catch (e) {
                    console.log(`Proxy ${proxy || 'direct'} failed:`, e.message);
                }
            }

            statusEl.className = 'status error';
            statusEl.textContent = '‚úó Failed - try downloading the file';
            return null;
        }

        function parseNumber(str) {
            if (!str || typeof str !== 'string') return null;
            str = str.trim();
            if (str === '' || str === '‚Äî' || str === '-' || str === 'N/A' || str === '‚Äì' || str === '‚Äî' || str === '‚Äî') return null;
            
            // Remove currency symbols, commas, spaces, non-breaking spaces
            let clean = str.replace(/[$‚Ç¨¬£¬•,\s\u00A0]/g, '');
            
            // Check for parentheses or minus (negative)
            const isNegative = clean.includes('(') || clean.startsWith('-') || clean.includes('‚àí');
            clean = clean.replace(/[()‚àí\-]/g, '');
            
            // Must be a valid number
            if (!/^\d+\.?\d*$/.test(clean)) return null;
            
            const num = parseFloat(clean);
            if (isNaN(num)) return null;
            
            return isNegative ? -num : num;
        }

        // Extract the filing period from the cover page
        function extractFilingPeriod(text) {
            // Look for "For the quarterly period ended [DATE]"
            const patterns = [
                /for\s+the\s+quarterly\s+period\s+ended\s+(\w+\s+\d{1,2},?\s+\d{4})/i,
                /quarterly\s+period\s+ended\s+(\w+\s+\d{1,2},?\s+\d{4})/i,
                /period\s+ended\s+(\w+\s+\d{1,2},?\s+\d{4})/i,
                /(?:three|nine|six)\s+months\s+ended\s+(\w+\s+\d{1,2},?\s+\d{4})/i,
                /as\s+of\s+(\w+\s+\d{1,2},?\s+\d{4})/i,
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    return match[1].trim();
                }
            }
            return null;
        }

        // Parse a date string to get year and month for column matching
        function parsePeriodDate(periodStr) {
            if (!periodStr) return null;
            
            const months = {
                'january': 1, 'february': 2, 'march': 3, 'april': 4, 'may': 5, 'june': 6,
                'july': 7, 'august': 8, 'september': 9, 'october': 10, 'november': 11, 'december': 12
            };
            
            const match = periodStr.toLowerCase().match(/(\w+)\s+\d{1,2},?\s+(\d{4})/);
            if (match) {
                const month = months[match[1]];
                const year = parseInt(match[2]);
                if (month && year) {
                    return { month, year };
                }
            }
            return null;
        }

        // Detect the multiplier from table text (thousands vs millions)
        function detectMultiplier(tableText) {
            const text = tableText.toLowerCase();
            
            console.log(`detectMultiplier: Scanning ${text.length} chars`);
            
            // THOUSANDS -> multiply by 0.001 to convert to millions
            // Look for common patterns anywhere in the table
            if (text.includes('in thousands') || text.includes('(thousands)') ||
                text.includes('$ thousands') || text.includes('except per share') ||
                text.includes('except share') || text.includes('except per-share')) {
                console.log(`  -> Detected THOUSANDS, multiplier = 0.001`);
                return 0.001;
            }
            
            // MILLIONS -> already in millions, multiplier = 1
            if (text.includes('in millions') || text.includes('(millions)') ||
                text.includes('$ millions')) {
                console.log(`  -> Detected MILLIONS, multiplier = 1`);
                return 1;
            }
            
            // BILLIONS -> multiply by 1000 to convert to millions
            if (text.includes('in billions') || text.includes('(billions)')) {
                console.log(`  -> Detected BILLIONS, multiplier = 1000`);
                return 1000;
            }
            
            // Heuristic: If numbers in the table are large (>10000), likely thousands
            // If numbers are smaller (<5000), likely millions
            const numbers = text.match(/[\d,]+/g) || [];
            const largeNumbers = numbers.filter(n => {
                const val = parseInt(n.replace(/,/g, ''));
                return val > 10000 && val < 10000000;
            });
            
            if (largeNumbers.length > 5) {
                console.log(`  -> Heuristic: Found ${largeNumbers.length} large numbers, assuming THOUSANDS`);
                return 0.001;
            }
            
            // Default: assume MILLIONS
            console.log(`  -> No unit indicator found, defaulting to MILLIONS`);
            return 1;
        }

        // Find the column index that matches the filing period
        function findPeriodColumnIndex(headerRow, periodDate) {
            if (!periodDate || !headerRow) return 1; // Default to first data column
            
            const cells = headerRow.querySelectorAll('td, th');
            
            for (let i = 0; i < cells.length; i++) {
                const cellText = cells[i].textContent.toLowerCase();
                
                // Check if this column header contains the filing period
                const monthNames = ['january', 'february', 'march', 'april', 'may', 'june',
                                   'july', 'august', 'september', 'october', 'november', 'december'];
                const monthName = monthNames[periodDate.month - 1];
                
                if (cellText.includes(monthName) && cellText.includes(periodDate.year.toString())) {
                    return i;
                }
                
                // Also check for abbreviated months
                const abbrevMonth = monthName.substring(0, 3);
                if (cellText.includes(abbrevMonth) && cellText.includes(periodDate.year.toString())) {
                    return i;
                }
            }
            
            return 1; // Default to first data column after label
        }

        // Score how likely a table is to be the Income Statement
        // ONLY looking for: CONDENSED CONSOLIDATED STATEMENTS OF OPERATIONS
        // or: UNAUDITED CONDENSED CONSOLIDATED STATEMENTS OF OPERATIONS AND COMPREHENSIVE INCOME
        function scoreFinancialTable(table, statementType) {
            const text = table.textContent.toLowerCase();
            const rows = table.querySelectorAll('tr');
            
            // Basic sanity checks
            if (rows.length < 5) return -1000;
            
            // REJECT: Table of contents, notes, schedules
            if (text.includes('table of contents')) return -1000;
            if (text.includes('part i') && text.includes('part ii') && text.includes('item')) return -1000;
            if (text.includes('notes to consolidated') || text.includes('notes to condensed')) return -1000;
            if (text.includes('schedule of')) return -1000;
            
            // REJECT: If "page" appears multiple times (likely TOC)
            const pageMatches = (text.match(/\bpage\b/g) || []).length;
            if (pageMatches > 2) return -1000;
            
            if (statementType === 'income') {
                // EXACT MATCHES ONLY for income statement headers
                // Priority 1: Exact header matches (highest scores)
                if (text.includes('condensed consolidated statements of operations and comprehensive income')) return 100;
                if (text.includes('unaudited condensed consolidated statements of operations')) return 100;
                if (text.includes('condensed consolidated statements of operations')) return 100;
                
                // Priority 2: Slightly less specific but still valid
                if (text.includes('consolidated statements of operations') && 
                    !text.includes('notes') && 
                    (text.includes('three months') || text.includes('nine months'))) return 80;
                
                // Must have key income statement line items to be considered at all
                const hasRevenue = text.includes('revenue') || text.includes('net sales');
                const hasExpenses = text.includes('operating expenses') || text.includes('cost of');
                const hasIncome = text.includes('net income') || text.includes('net loss');
                
                if (hasRevenue && hasExpenses && hasIncome) return 50;
                
                // Not a valid income statement
                return -1000;
            }
            
            // For now, skip balance sheet and cash flow (will fix later)
            return -1000;
        }

        function findBestTable(doc, statementType) {
            const tables = doc.querySelectorAll('table');
            let bestTable = null;
            let bestScore = -Infinity;
            
            for (const table of tables) {
                const score = scoreFinancialTable(table, statementType);
                if (score > bestScore) {
                    bestScore = score;
                    bestTable = table;
                }
            }
            
            return bestScore > 0 ? bestTable : null;
        }

        // Find the column index for "Three Months Ended" with the target year (2025)
        // SEC 10-Q tables typically have headers like:
        //   Row 1: |              | Three Months Ended |              | Nine Months Ended  |              |
        //   Row 2: |              | Sept 30, 2025      | Sept 30, 2024| Sept 30, 2025      | Sept 30, 2024|
        // We want the FIRST column with "2025" that is under "Three Months" (not "Nine Months")
        function findQuarterlyColumnIndex(rows, targetYear) {
            console.log(`Looking for quarterly column with year ${targetYear}`);
            
            // Strategy: Find all columns with the target year, then pick the first one
            // that's NOT under a "Nine Months" header
            
            let yearColumns = []; // Array of {colIndex, year, isNineMonths}
            let currentPeriodType = null; // 'three' or 'nine' - tracks the most recent period header
            
            // First pass: identify period type headers (Three Months vs Nine Months)
            // These often span multiple columns
            let periodTypeByCol = {}; // colIndex -> 'three' or 'nine'
            
            for (const row of rows.slice(0, 10)) {
                const cells = Array.from(row.querySelectorAll('td, th'));
                let lastPeriodType = null;
                
                for (let i = 0; i < cells.length; i++) {
                    const cellText = cells[i].textContent.toLowerCase().trim();
                    
                    if (cellText.includes('three months')) {
                        lastPeriodType = 'three';
                        periodTypeByCol[i] = 'three';
                        console.log(`  Col ${i}: THREE MONTHS header`);
                    } else if (cellText.includes('nine months')) {
                        lastPeriodType = 'nine';
                        periodTypeByCol[i] = 'nine';
                        console.log(`  Col ${i}: NINE MONTHS header`);
                    }
                    
                    // Check for year in this cell
                    const yearMatch = cellText.match(/20\d{2}/);
                    if (yearMatch) {
                        const year = parseInt(yearMatch[0]);
                        // Inherit period type from the last seen header or from same column
                        const periodType = periodTypeByCol[i] || lastPeriodType;
                        yearColumns.push({ col: i, year, periodType });
                        console.log(`  Col ${i}: Year ${year}, period type: ${periodType || 'unknown'}`);
                    }
                }
            }
            
            // PRIORITY 1: Find target year (2025) under "Three Months"
            for (const entry of yearColumns) {
                if (entry.year === targetYear && entry.periodType === 'three') {
                    console.log(`  => Using col ${entry.col} (${targetYear} under Three Months)`);
                    return entry.col;
                }
            }
            
            // PRIORITY 2: Find target year (2025) NOT under "Nine Months"
            for (const entry of yearColumns) {
                if (entry.year === targetYear && entry.periodType !== 'nine') {
                    console.log(`  => Using col ${entry.col} (${targetYear}, not Nine Months)`);
                    return entry.col;
                }
            }
            
            // PRIORITY 3: Find ANY target year column (first one)
            for (const entry of yearColumns) {
                if (entry.year === targetYear) {
                    console.log(`  => Using col ${entry.col} (${targetYear}, any period)`);
                    return entry.col;
                }
            }
            
            // PRIORITY 4: First column with any year
            if (yearColumns.length > 0) {
                console.log(`  => Fallback to first year column: ${yearColumns[0].col}`);
                return yearColumns[0].col;
            }
            
            console.log(`  => No quarterly column found, returning -1`);
            return -1;
        }

        // Extract value from table, using the correct column for the filing period
        // STRICT matching: label must START WITH or EQUAL the keyword
        function extractValueFromTable(table, keywords, multiplier, periodDate) {
            if (!table) return null;
            
            const rows = Array.from(table.querySelectorAll('tr'));
            const keywordsLower = keywords.map(k => k.toLowerCase().trim());
            
            // Determine the target year from the filing period
            let targetYear = periodDate?.year || new Date().getFullYear();
            
            // Find the quarterly column for the target year
            let quarterlyColumnIndex = findQuarterlyColumnIndex(rows, targetYear);
            
            // Build a map of which columns are "three months" vs "nine months"
            let columnTypes = {}; // index -> 'three' or 'nine'
            for (const row of rows.slice(0, 10)) {
                const cells = Array.from(row.querySelectorAll('td, th'));
                for (let i = 0; i < cells.length; i++) {
                    const cellText = cells[i].textContent.toLowerCase();
                    if (cellText.includes('three months')) {
                        columnTypes[i] = 'three';
                    } else if (cellText.includes('nine months')) {
                        columnTypes[i] = 'nine';
                    }
                }
            }
            
            // Search for matching rows - try each keyword in order (first keyword = highest priority)
            // Keywords are ordered: 'total net revenues' before 'revenues'
            for (const keyword of keywordsLower) {
                for (const row of rows) {
                    const cells = Array.from(row.querySelectorAll('td, th'));
                    if (cells.length < 2) continue;
                    
                    // Get label from first cell(s)
                    let labelText = '';
                    let labelEndIndex = 0;
                    for (let i = 0; i < Math.min(3, cells.length); i++) {
                        const cellContent = cells[i].textContent.trim().replace(/\s+/g, ' ').toLowerCase();
                        // Stop if we hit a number cell
                        if (/^[\d,$().\-‚Äî‚Äì\s]*$/.test(cellContent) && cellContent.length > 0) {
                            if (labelText) break;
                            continue;
                        }
                        if (cellContent) {
                            labelText += ' ' + cellContent;
                            labelEndIndex = i;
                        }
                    }
                    labelText = labelText.trim();
                    if (!labelText) continue;
                    
                    // Check if this row matches the current keyword
                    // Must be a strong match - keyword should be the main content
                    const keywordIndex = labelText.indexOf(keyword);
                    if (keywordIndex === -1) continue;
                    
                    // For "total" keywords, the label must contain "total"
                    if (keyword.includes('total') && !labelText.includes('total')) continue;
                    
                    // Reject if keyword is buried in a longer phrase
                    // e.g., "transaction-based revenues" should NOT match "revenues"
                    // but "total net revenues" SHOULD match "total net revenues"
                    if (keyword === 'revenues' || keyword === 'revenue') {
                        // Only match if "revenues"/"revenue" is at the END of the label
                        // or the label is very short
                        if (!labelText.endsWith('revenues') && !labelText.endsWith('revenue') && labelText.length > 20) {
                            continue;
                        }
                    }
                    
                    console.log(`Matched "${keyword}" in label: "${labelText}"`);
                    
                    // Extract value from the correct column
                    // PRIORITY 1: Use the identified quarterly column
                    if (quarterlyColumnIndex >= 0 && quarterlyColumnIndex < cells.length) {
                        const num = parseNumber(cells[quarterlyColumnIndex].textContent);
                        if (num !== null) {
                            console.log(`  -> Value: ${num} * ${multiplier} = ${num * multiplier} (col ${quarterlyColumnIndex})`);
                            return num * multiplier;
                        }
                    }
                    
                    // PRIORITY 2: Find first numeric column after label, skipping "nine months"
                    for (let i = labelEndIndex + 1; i < cells.length; i++) {
                        if (columnTypes[i] === 'nine') continue;
                        
                        const num = parseNumber(cells[i].textContent);
                        if (num !== null) {
                            console.log(`  -> Value: ${num} * ${multiplier} = ${num * multiplier} (col ${i})`);
                            return num * multiplier;
                        }
                    }
                }
            }
            
            return null;
        }

        function extractCompanyInfo(html, fullText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract filing period - this is critical
            const period = extractFilingPeriod(fullText) || 'N/A';
            
            // Company name from title or filename
            let name = 'Unknown';
            const titleEl = doc.querySelector('title');
            if (titleEl) {
                const titleText = titleEl.textContent;
                const titleMatch = titleText.match(/^([^-‚Äì]+)/);
                if (titleMatch && titleMatch[1].length > 2 && titleMatch[1].length < 50) {
                    name = titleMatch[1].trim();
                }
            }
            
            // Try other patterns
            if (name === 'Unknown' || name.length < 3) {
                const patterns = [
                    /REGISTRANT[:\s]+([A-Z][A-Za-z\s&,\.]+)/i,
                    /COMPANY[:\s]+([A-Z][A-Za-z\s&,\.]+)/i,
                ];
                
                for (const pattern of patterns) {
                    const match = fullText.substring(0, 15000).match(pattern);
                    if (match && match[1].length > 3 && match[1].length < 60) {
                        name = match[1].trim().replace(/\s+/g, ' ');
                        break;
                    }
                }
            }
            
            // CIK
            let cik = 'N/A';
            const cikMatch = fullText.match(/Commission\s+File\s+(?:Number|No\.?)[:\s]+(\d+-\d+)/i) ||
                            fullText.match(/File\s+(?:Number|No\.?)[:\s]+(\d+-\d+)/i) ||
                            fullText.match(/CIK[:\s#]+(\d{7,10})/i);
            if (cikMatch) {
                cik = cikMatch[1];
            }
            
            return { name, period, cik };
        }

        function analyzeHTML(html, url) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const fullText = doc.body.textContent;
            
            const info = extractCompanyInfo(html, fullText);
            const periodDate = parsePeriodDate(info.period);
            
            // Find the best tables
            const incomeTable = findBestTable(doc, 'income');
            const balanceTable = findBestTable(doc, 'balance');
            const cashflowTable = findBestTable(doc, 'cashflow');
            
            // Detect multipliers for each table
            const incomeMultiplier = incomeTable ? detectMultiplier(incomeTable.textContent) : 1;
            const balanceMultiplier = balanceTable ? detectMultiplier(balanceTable.textContent) : 1;
            const cashflowMultiplier = cashflowTable ? detectMultiplier(cashflowTable.textContent) : 1;
            
            console.log(`${info.name}: Income multiplier=${incomeMultiplier}, Balance multiplier=${balanceMultiplier}`);
            
            console.log(`=== Extracting financials for ${info.name} ===`);
            console.log(`Income table found: ${!!incomeTable}`);
            console.log(`Income multiplier: ${incomeMultiplier}`);
            console.log(`Period date: ${JSON.stringify(periodDate)}`);
            
            const financials = {
                // Income Statement - order matters! More specific first
                revenue: extractValueFromTable(incomeTable, [
                    'total net revenues', 'total revenues', 'net revenues',
                    'total net sales', 'total sales', 'net sales', 
                    'revenues', 'revenue'
                ], incomeMultiplier, periodDate),
                
                costOfRevenue: extractValueFromTable(incomeTable, [
                    'cost of revenue', 'cost of revenues', 'cost of sales',
                    'cost of goods sold', 'total costs and expenses'
                ], incomeMultiplier, periodDate),
                
                grossProfit: extractValueFromTable(incomeTable, [
                    'gross profit', 'gross margin'
                ], incomeMultiplier, periodDate),
                
                operatingIncome: extractValueFromTable(incomeTable, [
                    'income from operations', 'operating income', 'operating income (loss)',
                    'income before income taxes', 'income before interest income and income taxes',
                    'gain from operations', 'loss from operations',
                    'income (loss) from operations', 'loss from operations'
                ], incomeMultiplier, periodDate),
                
                netIncome: extractValueFromTable(incomeTable, [
                    'net income', 'net income (loss)', 'net earnings',
                    'net income attributable', 'net loss', 'net earnings (loss)',
                    'net income attributable to common stockholders',
                    'net income attributable to duolingo'
                ], incomeMultiplier, periodDate),
                
                // Balance Sheet
                totalAssets: extractValueFromTable(balanceTable, [
                    'total assets'
                ], balanceMultiplier, periodDate),
                
                cash: extractValueFromTable(balanceTable, [
                    'cash and cash equivalents'
                ], balanceMultiplier, periodDate),
                
                marketableSecurities: extractValueFromTable(balanceTable, [
                    'marketable securities', 'short-term investments'
                ], balanceMultiplier, periodDate),
                
                currentAssets: extractValueFromTable(balanceTable, [
                    'total current assets'
                ], balanceMultiplier, periodDate),
                
                totalLiabilities: extractValueFromTable(balanceTable, [
                    'total liabilities'
                ], balanceMultiplier, periodDate),
                
                currentLiabilities: extractValueFromTable(balanceTable, [
                    'total current liabilities'
                ], balanceMultiplier, periodDate),
                
                longTermDebt: extractValueFromTable(balanceTable, [
                    'long-term debt', 'long-term notes payable', 'long-term borrowings'
                ], balanceMultiplier, periodDate),
                
                totalEquity: extractValueFromTable(balanceTable, [
                    "total stockholders' equity", "total shareholders' equity",
                    "stockholders' equity", 'total equity'
                ], balanceMultiplier, periodDate),
                
                // Cash Flow
                operatingCF: extractValueFromTable(cashflowTable, [
                    'net cash provided by operating activities',
                    'net cash from operating activities',
                    'cash provided by operating activities',
                    'net cash used in operating activities'
                ], cashflowMultiplier, periodDate),
                
                investingCF: extractValueFromTable(cashflowTable, [
                    'net cash used in investing activities',
                    'net cash from investing activities',
                    'net cash provided by investing activities'
                ], cashflowMultiplier, periodDate),
                
                financingCF: extractValueFromTable(cashflowTable, [
                    'net cash used in financing activities',
                    'net cash from financing activities',
                    'net cash provided by financing activities'
                ], cashflowMultiplier, periodDate),
                
                capex: extractValueFromTable(cashflowTable, [
                    'purchases of property and equipment',
                    'capital expenditures',
                    'purchases of property, plant and equipment'
                ], cashflowMultiplier, periodDate),
            };
            
            // Calculated metrics
            if (financials.operatingCF !== null && financials.capex !== null) {
                financials.freeCashFlow = financials.operatingCF - Math.abs(financials.capex);
            }
            
            if (financials.revenue && financials.netIncome && financials.revenue !== 0) {
                financials.netMargin = (financials.netIncome / financials.revenue) * 100;
            }
            
            if (financials.currentAssets && financials.currentLiabilities && financials.currentLiabilities !== 0) {
                financials.currentRatio = financials.currentAssets / financials.currentLiabilities;
            }
            
            if (financials.longTermDebt && financials.totalAssets && financials.totalAssets !== 0) {
                financials.debtToAssets = (financials.longTermDebt / financials.totalAssets) * 100;
            }
            
            if (financials.cash !== null) {
                financials.netCash = financials.cash - (financials.longTermDebt || 0);
            }
            
            return {
                name: info.name,
                period: info.period,
                cik: info.cik,
                url: url,
                financials: financials
            };
        }

        async function analyzeAll() {
            const urls = [
                document.getElementById('url1').value.trim(),
                document.getElementById('url2').value.trim(),
                document.getElementById('url3').value.trim()
            ];
            
            if (urls.some(u => !u)) {
                alert('Please enter all 3 URLs');
                return;
            }
            
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loading').classList.add('visible');
            document.getElementById('results').classList.remove('visible');
            
            analysisResults = [];
            
            for (let i = 0; i < 3; i++) {
                const statusEl = document.getElementById(`status${i + 1}`);
                const html = await fetchHTML(urls[i], statusEl);
                
                if (html) {
                    const result = analyzeHTML(html, urls[i]);
                    analysisResults.push(result);
                } else {
                    analysisResults.push({
                        name: `Company ${i + 1} (Failed)`,
                        period: 'N/A',
                        cik: 'N/A',
                        url: urls[i],
                        financials: {}
                    });
                }
            }
            
            document.getElementById('loading').classList.remove('visible');
            document.getElementById('analyzeBtn').disabled = false;
            
            displayResults();
        }

        // Format number - all values are in millions
        function fmt(val) {
            if (val === null || val === undefined) return '<span class="na">N/A</span>';
            
            const absVal = Math.abs(val);
            let formatted;
            let suffix;
            
            if (absVal >= 1000) {
                formatted = (val / 1000).toFixed(1);
                suffix = 'B';
            } else if (absVal >= 1) {
                formatted = val.toFixed(1);
                suffix = 'M';
            } else if (absVal >= 0.001) {
                formatted = (val * 1000).toFixed(0);
                suffix = 'K';
            } else {
                return '<span class="na">N/A</span>';
            }
            
            const cls = val < 0 ? 'negative' : 'positive';
            return `<span class="${cls}">$${formatted}${suffix}</span>`;
        }

        function fmtPct(val) {
            if (val === null || val === undefined) return '<span class="na">N/A</span>';
            const cls = val < 0 ? 'negative' : 'positive';
            return `<span class="${cls}">${val.toFixed(1)}%</span>`;
        }

        function fmtRatio(val) {
            if (val === null || val === undefined) return '<span class="na">N/A</span>';
            const cls = val < 1 ? 'negative' : 'positive';
            return `<span class="${cls}">${val.toFixed(2)}</span>`;
        }

        function displayResults() {
            const cos = analysisResults;
            
            ['i', 'b', 'c', 'r'].forEach(prefix => {
                for (let i = 0; i < 3; i++) {
                    document.getElementById(`${prefix}-h${i + 1}`).textContent = cos[i].name.substring(0, 18);
                }
            });
            
            document.querySelector('#overviewTable tbody').innerHTML = cos.map((c, i) => `
                <tr><td>${i + 1}</td><td>${c.name}</td><td>${c.period}</td><td>${c.cik}</td></tr>
            `).join('');
            
            const incomeMetrics = [
                ['Revenue', 'revenue'],
                ['Cost of Revenue', 'costOfRevenue'],
                ['Gross Profit', 'grossProfit'],
                ['Operating Income', 'operatingIncome'],
                ['Net Income', 'netIncome'],
                ['Net Margin', 'netMargin', 'pct'],
            ];
            
            document.querySelector('#incomeTable tbody').innerHTML = incomeMetrics.map(([label, key, type]) => `
                <tr>
                    <td class="metric-name">${label}</td>
                    ${cos.map(c => `<td>${type === 'pct' ? fmtPct(c.financials[key]) : fmt(c.financials[key])}</td>`).join('')}
                </tr>
            `).join('');
            
            const balanceMetrics = [
                ['Total Assets', 'totalAssets'],
                ['Cash & Equivalents', 'cash'],
                ['Marketable Securities', 'marketableSecurities'],
                ['Current Assets', 'currentAssets'],
                ['Total Liabilities', 'totalLiabilities'],
                ['Current Liabilities', 'currentLiabilities'],
                ['Long-Term Debt', 'longTermDebt'],
                ['Total Equity', 'totalEquity'],
            ];
            
            document.querySelector('#balanceTable tbody').innerHTML = balanceMetrics.map(([label, key]) => `
                <tr>
                    <td class="metric-name">${label}</td>
                    ${cos.map(c => `<td>${fmt(c.financials[key])}</td>`).join('')}
                </tr>
            `).join('');
            
            const cfMetrics = [
                ['Operating Cash Flow', 'operatingCF'],
                ['Investing Cash Flow', 'investingCF'],
                ['Financing Cash Flow', 'financingCF'],
                ['Capital Expenditures', 'capex'],
                ['Free Cash Flow', 'freeCashFlow'],
            ];
            
            document.querySelector('#cashflowTable tbody').innerHTML = cfMetrics.map(([label, key]) => `
                <tr>
                    <td class="metric-name">${label}</td>
                    ${cos.map(c => `<td>${fmt(c.financials[key])}</td>`).join('')}
                </tr>
            `).join('');
            
            const ratioMetrics = [
                ['Current Ratio', 'currentRatio', 'ratio'],
                ['Debt-to-Assets', 'debtToAssets', 'pct'],
                ['Net Cash Position', 'netCash', 'num'],
            ];
            
            document.querySelector('#ratiosTable tbody').innerHTML = ratioMetrics.map(([label, key, type]) => `
                <tr>
                    <td class="metric-name">${label}</td>
                    ${cos.map(c => `<td>${type === 'pct' ? fmtPct(c.financials[key]) : type === 'ratio' ? fmtRatio(c.financials[key]) : fmt(c.financials[key])}</td>`).join('')}
                </tr>
            `).join('');
            
            const summaries = [];
            const validRev = cos.filter(c => c.financials.revenue);
            if (validRev.length) {
                const best = validRev.reduce((a, b) => (a.financials.revenue || 0) > (b.financials.revenue || 0) ? a : b);
                summaries.push({ title: 'üí∞ Highest Revenue', text: `${best.name} ($${(best.financials.revenue >= 1000 ? (best.financials.revenue/1000).toFixed(1) + 'B' : best.financials.revenue.toFixed(0) + 'M')})` });
            }
            
            const validAssets = cos.filter(c => c.financials.totalAssets);
            if (validAssets.length) {
                const best = validAssets.reduce((a, b) => (a.financials.totalAssets || 0) > (b.financials.totalAssets || 0) ? a : b);
                summaries.push({ title: 'üèÜ Largest by Assets', text: `${best.name}` });
            }
            
            const validMargin = cos.filter(c => c.financials.netMargin !== null && c.financials.netMargin !== undefined);
            if (validMargin.length) {
                const best = validMargin.reduce((a, b) => (a.financials.netMargin || -999) > (b.financials.netMargin || -999) ? a : b);
                summaries.push({ title: 'üìà Best Net Margin', text: `${best.name} (${best.financials.netMargin.toFixed(1)}%)` });
            }
            
            document.getElementById('summaryCards').innerHTML = summaries.map(s => `
                <div class="summary-card"><h4>${s.title}</h4><p>${s.text}</p></div>
            `).join('') || '<div class="summary-card"><h4>üìä Analysis Complete</h4></div>';
            
            const flags = [];
            for (const c of cos) {
                const f = [];
                if (c.financials.netIncome !== null && c.financials.netIncome < 0) {
                    f.push(`Net loss reported`);
                }
                if (c.financials.freeCashFlow !== null && c.financials.freeCashFlow < 0) {
                    f.push(`Negative free cash flow`);
                }
                if (c.financials.currentRatio !== null && c.financials.currentRatio < 1) {
                    f.push(`Low current ratio (${c.financials.currentRatio.toFixed(2)})`);
                }
                if (f.length) flags.push({ company: c.name, flags: f });
            }
            
            document.getElementById('redFlags').innerHTML = flags.length ? flags.map(f => `
                <div class="summary-card warning">
                    <h4>‚ö†Ô∏è ${f.company.substring(0, 25)}</h4>
                    ${f.flags.map(fl => `<div class="red-flag">‚Ä¢ ${fl}</div>`).join('')}
                </div>
            `).join('') : '<div class="summary-card"><h4>‚úÖ No Major Red Flags</h4></div>';
            
            document.getElementById('results').classList.add('visible');
        }

        function exportMarkdown() {
            const cos = analysisResults;
            let md = `# 10-Q Comparison Report\n\nGenerated: ${new Date().toLocaleString()}\n\n`;
            md += `## Companies\n`;
            cos.forEach((c, i) => md += `${i + 1}. **${c.name}** - ${c.period}\n`);
            md += `\n## Key Metrics (in millions USD)\n`;
            md += `| Metric | ${cos.map(c => c.name.substring(0, 15)).join(' | ')} |\n`;
            md += `|--------|${cos.map(() => '---').join('|')}|\n`;
            
            const fmtMd = (v) => v === null ? 'N/A' : (Math.abs(v) >= 1000 ? `$${(v/1000).toFixed(1)}B` : `$${v.toFixed(0)}M`);
            
            md += `| Revenue | ${cos.map(c => fmtMd(c.financials.revenue)).join(' | ')} |\n`;
            md += `| Net Income | ${cos.map(c => fmtMd(c.financials.netIncome)).join(' | ')} |\n`;
            md += `| Total Assets | ${cos.map(c => fmtMd(c.financials.totalAssets)).join(' | ')} |\n`;
            
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '10q_comparison.md';
            a.click();
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify({ generated: new Date().toISOString(), companies: analysisResults }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '10q_comparison.json';
            a.click();
        }

        function exportCSV() {
            const cos = analysisResults;
            let csv = 'Metric,' + cos.map(c => `"${c.name}"`).join(',') + '\n';
            const metrics = ['revenue', 'netIncome', 'operatingIncome', 'grossProfit', 'totalAssets', 'cash', 'totalLiabilities', 'totalEquity', 'operatingCF', 'freeCashFlow', 'netMargin', 'currentRatio'];
            metrics.forEach(m => {
                csv += `${m},${cos.map(c => c.financials[m] ?? '').join(',')}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '10q_comparison.csv';
            a.click();
        }
    </script>
</body>
</html>

